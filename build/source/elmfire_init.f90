MODULE ELMFIRE_INIT

USE ELMFIRE_VARS

IMPLICIT NONE

CONTAINS

! *****************************************************************************
SUBROUTINE SET_MISC_PARAMETERS(R1)
! *****************************************************************************

REAL, DIMENSION(:) :: R1
INTEGER :: I
I = NUM_PARAMETERS_RASTERS + NUM_PARAMETERS_SPOTTING

IF (PERTURB_WIND_DIRECTION_FLUCTUATION_INTENSITY) THEN
   I = I + 1
   WIND_DIRECTION_FLUCTUATION_INTENSITY = WIND_DIRECTION_FLUCTUATION_INTENSITY_MIN + &
   R1(I)*(WIND_DIRECTION_FLUCTUATION_INTENSITY_MAX - WIND_DIRECTION_FLUCTUATION_INTENSITY_MIN)
   COEFFS_UNSCALED(I)=WIND_DIRECTION_FLUCTUATION_INTENSITY
ENDIF

IF (PERTURB_WIND_SPEED_FLUCTUATION_INTENSITY) THEN
   I = I + 1
   WIND_SPEED_FLUCTUATION_INTENSITY = WIND_SPEED_FLUCTUATION_INTENSITY_MIN + &
   R1(I)*(WIND_SPEED_FLUCTUATION_INTENSITY_MAX - WIND_SPEED_FLUCTUATION_INTENSITY_MIN)
   COEFFS_UNSCALED(I)=WIND_SPEED_FLUCTUATION_INTENSITY
ENDIF

! *****************************************************************************
END SUBROUTINE SET_MISC_PARAMETERS
! *****************************************************************************

! *****************************************************************************
SUBROUTINE CHECK_INPUTS(GOOD_INPUTS)
! *****************************************************************************

LOGICAL, INTENT(OUT) :: GOOD_INPUTS

GOOD_INPUTS = .TRUE. 

IF (MODE .NE. 2 .AND. DT_METEOROLOGY .LE. 0.) THEN
   WRITE(*,*) 'Specify DT_METEOROLOGY in the &INPUTS namelist group.'
   GOOD_INPUTS = .FALSE. 
ENDIF

IF (USE_BLDG_SPREAD_MODEL) THEN
   IF (.NOT. USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS) THEN
         IF (TRIM(BLDG_AREA_FILENAME) .EQ. '' ) THEN
            WRITE(*,*) 'Specify BLDG_AREA_FILENAME or set USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS = .TRUE.'
            GOOD_INPUTS = .FALSE.
         ENDIF

         IF (TRIM(BLDG_SEPARATION_DIST_FILENAME) .EQ. '' ) THEN
            WRITE(*,*) 'Specify BLDG_SEPARATION_DIST_FILENAME or set USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS = .TRUE.'
            GOOD_INPUTS = .FALSE.
         ENDIF

         IF (TRIM(BLDG_NONBURNABLE_FRAC_FILENAME) .EQ. '' ) THEN
            WRITE(*,*) 'Specify BLDG_NONBURNABLE_FRAC_FILENAME or set USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS = .TRUE.'
            GOOD_INPUTS = .FALSE.
         ENDIF

         IF (TRIM(BLDG_FOOTPRINT_FRAC_FILENAME) .EQ. '' ) THEN
            WRITE(*,*) 'Specify BLDG_FOOTPRINT_FRAC_FILENAME or set USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS = .TRUE.'
            GOOD_INPUTS = .FALSE.
         ENDIF

         IF (TRIM(BLDG_FUEL_MODEL_FILENAME) .EQ. '' ) THEN
            WRITE(*,*) 'Specify BLDG_FUEL_MODEL_FILENAME or set USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS = .TRUE.'
            GOOD_INPUTS = .FALSE.
         ENDIF
   ENDIF

ELSE

   IF (ENABLE_SPOTTING .AND. (.NOT. USE_SUPERSEDED_SPOTTING) ) THEN
      IF (.NOT. USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS) THEN
         IF (TRIM(BLDG_FOOTPRINT_FRAC_FILENAME) .EQ. '' ) THEN
            WRITE(*,*) 'Specify BLDG_FOOTPRINT_FRAC_FILENAME or set USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS = .TRUE.'
            GOOD_INPUTS = .FALSE.
         ENDIF
      ENDIF
   ENDIF

ENDIF

! *****************************************************************************
END SUBROUTINE CHECK_INPUTS
! *****************************************************************************

! *****************************************************************************
SUBROUTINE INIT_LOOKUP_TABLES
! *****************************************************************************

INTEGER :: I, ICC, ICH
REAL :: CC1, CH1

! Initialize trigonometric arrays (tan^2(slp), sin(asp-180.), cos(asp-180.)
DO I =0,89
   TANSLP2(I) = TAN(REAL(I)*PIO180)
   COSSLP (I) = COS(REAL(I)*PIO180)
ENDDO
TANSLP2(90) = 100.0
TANSLP2(:)=TANSLP2(:)*TANSLP2(:)

DO I=0,360
   ABSSINASP(I)=ABS(SIN(REAL(I)*PIO180))
   ABSCOSASP(I)=ABS(COS(REAL(I)*PIO180))
   SINASPM180(I)=SIN((REAL(I) - 180.)*PIO180)
   COSASPM180(I)=COS((REAL(I) - 180.)*PIO180)
ENDDO

! Sine and Cosine of wind direction minus pi, used in UX_AND_UY routines
DO I = 0, 3600
   SINWDMPI(I) = SIN( (REAL(I)*0.1 - 180.) * PIO180)
   COSWDMPI(I) = COS( (REAL(I)*0.1 - 180.) * PIO180)
ENDDO

! Set up sheltered wind adjustment factor table
DO ICC = 0, 100
   CC1=REAL(ICC)*0.01
   DO ICH = 0, 120
      CH1 = REAL(ICH)
      SHELTERED_WAF_TABLE(ICC,ICH) = CALC_WIND_ADJUSTMENT_FACTOR_SINGLE(CC1, CH1, 0.)
   ENDDO
ENDDO

! *****************************************************************************
END SUBROUTINE INIT_LOOKUP_TABLES
! *****************************************************************************

! *****************************************************************************
SUBROUTINE INIT_RASTERS
! *****************************************************************************

INTEGER :: IX, IY, J
REAL :: ARG

CALL CALC_WIND_ADJUSTMENT_FACTOR_EVERYWHERE(CC, CH, FBFM, WAF)

! 1 - cos (slp)
DO IY = 1, FBFM%NROWS
DO IX = 1, FBFM%NCOLS
   IF (SLP%R4(IX,IY,1) .NE. SLP%NODATA_VALUE) THEN 
      ARG = MIN(MAX(SLP%R4(IX,IY,1),0.),90.)
      OMCOSSLPRAD%R4(IX,IY,1) = 1. - COSSLP(NINT(ARG))
   ELSE
      OMCOSSLPRAD%R4(IX,IY,1) = 0.
   ENDIF
ENDDO
ENDDO

! Nonburnable mask
DO IY = 1, FBFM%NROWS
DO IX = 1, FBFM%NCOLS
   J = FBFM%I2(IX,IY,1)
   IF ( (J .GE. 90 .AND. J .LE. 100) .OR. J .EQ. 256 .OR. J .LE. 0) THEN
      ISNONBURNABLE(IX,IY) = .TRUE.
   ELSE
      ISNONBURNABLE(IX,IY) = .FALSE.
   ENDIF
   IF (USE_BLDG_SPREAD_MODEL .AND. J .EQ. 91) ISNONBURNABLE(IX,IY) = .FALSE.
ENDDO
ENDDO

IF (USE_IGNITION_MASK .AND. ADD_TO_IGNITION_MASK .GT. 0.) THEN
   DO IY = 1, IGN_MASK%NROWS
   DO IX = 1, IGN_MASK%NCOLS
      IF (.NOT. ISNONBURNABLE(IX,IY) ) IGN_MASK%R4(IX,IY,1) = IGN_MASK%R4(IX,IY,1) + ADD_TO_IGNITION_MASK
   ENDDO
   ENDDO
ENDIF

! *****************************************************************************
END SUBROUTINE INIT_RASTERS
! *****************************************************************************

! *****************************************************************************
SUBROUTINE SETUP_SHARED_MEMORY_1
! *****************************************************************************

INTEGER :: IERR

ANALYSIS_NCOLS = ASP%NCOLS
ANALYSIS_NROWS = ASP%NROWS
WX_NCOLS       = WS%NCOLS
WX_NROWS       = WS%NROWS
WX_NBANDS      = WS%NBANDS

ARRAYSHAPE_ANALYSIS_SINGLEBAND=(/ ANALYSIS_NCOLS, ANALYSIS_NROWS, 1 /)
ARRAYSHAPE_WX=(/ WX_NCOLS, WX_NROWS, WX_NBANDS /)
ARRAYSHAPE_ISNONBURNABLE=(/ ANALYSIS_NCOLS, ANALYSIS_NROWS /)

IF (IRANK_HOST .EQ. 0) THEN
   ANALYSIS_SINGLEBAND_SIZE_REAL = INT (ANALYSIS_NCOLS*ANALYSIS_NROWS,MPI_ADDRESS_KIND                      ) * 4_MPI_ADDRESS_KIND
   ANALYSIS_SINGLEBAND_SIZE_INT  = INT (ANALYSIS_NCOLS*ANALYSIS_NROWS,MPI_ADDRESS_KIND                      ) * 2_MPI_ADDRESS_KIND
   ANALYSIS_SINGLEBAND_SIZE_L1   = INT (ANALYSIS_NCOLS*ANALYSIS_NROWS,MPI_ADDRESS_KIND                      ) * 1_MPI_ADDRESS_KIND
   WX_SIZE                       = INT (WX_NCOLS*WX_NROWS*WX_NBANDS,MPI_ADDRESS_KIND                        ) * 4_MPI_ADDRESS_KIND
ELSE
   ANALYSIS_SINGLEBAND_SIZE_REAL = 0_MPI_ADDRESS_KIND
   ANALYSIS_SINGLEBAND_SIZE_INT  = 0_MPI_ADDRESS_KIND
   ANALYSIS_SINGLEBAND_SIZE_L1   = 0_MPI_ADDRESS_KIND
   WX_SIZE                       = 0_MPI_ADDRESS_KIND
ENDIF

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)

CALL MPI_WIN_ALLOCATE_SHARED (WX_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, WS_PTR   , WIN_WS   )
CALL MPI_WIN_ALLOCATE_SHARED (WX_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, WD_PTR   , WIN_WD   )
CALL MPI_WIN_ALLOCATE_SHARED (WX_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, M1_PTR   , WIN_M1   )
CALL MPI_WIN_ALLOCATE_SHARED (WX_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, M10_PTR  , WIN_M10  )
CALL MPI_WIN_ALLOCATE_SHARED (WX_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, M100_PTR , WIN_M100 )
CALL MPI_WIN_ALLOCATE_SHARED (WX_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, MLH_PTR  , WIN_MLH  )
CALL MPI_WIN_ALLOCATE_SHARED (WX_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, MLW_PTR  , WIN_MLW  )
CALL MPI_WIN_ALLOCATE_SHARED (WX_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, MFOL_PTR , WIN_MFOL )

IF (USE_ERC) THEN
   CALL MPI_WIN_ALLOCATE_SHARED (WX_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, ERC_PTR    , WIN_ERC    )
   CALL MPI_WIN_ALLOCATE_SHARED (WX_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, IGNFAC_PTR , WIN_IGNFAC )
ENDIF

IF (USE_IGNITION_MASK) CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, IGN_MASK_PTR      , WIN_IGN_MASK     )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, ASP_PTR           , WIN_ASP          )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, CBH_PTR           , WIN_CBH          )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, CBD_PTR           , WIN_CBD          )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, CC_PTR            , WIN_CC           )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, CH_PTR            , WIN_CH           )
IF (MODE .NE. 2) CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, DEM_PTR           , WIN_DEM          )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_INT , DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, FBFM_PTR          , WIN_FBFM         )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, SLP_PTR           , WIN_SLP          )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, ADJ_PTR           , WIN_ADJ          )
IF (MODE .NE. 2) CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, PHI0_PTR          , WIN_PHI0         )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, WAF_PTR           , WIN_WAF          )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, OMCOSSLPRAD_PTR   , WIN_OMCOSSLPRAD  )
CALL MPI_WIN_ALLOCATE_SHARED (ANALYSIS_SINGLEBAND_SIZE_L1  , DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, ISNONBURNABLE_PTR , WIN_ISNONBURNABLE )

IF (USE_POPULATION_DENSITY) CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, POPULATION_DENSITY_PTR , WIN_POPULATION_DENSITY)
IF (USE_REAL_ESTATE_VALUE ) CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, REAL_ESTATE_VALUE_PTR  , WIN_REAL_ESTATE_VALUE )
IF (USE_LAND_VALUE        ) CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, LAND_VALUE_PTR         , WIN_LAND_VALUE        )
IF (USE_SDI               ) CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, SDI_PTR                , WIN_SDI)
IF (USE_BLDG_SPREAD_MODEL) THEN
   CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, BLDG_AREA_PTR             , WIN_BLDG_AREA )
   CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, BLDG_SEPARATION_DIST_PTR  , WIN_BLDG_SEPARATION_DIST )
   CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, BLDG_NONBURNABLE_FRAC_PTR , WIN_BLDG_NONBURNABLE_FRAC)
   CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, BLDG_FOOTPRINT_FRAC_PTR   , WIN_BLDG_FOOTPRINT_FRAC)
   CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_INT , DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, BLDG_FUEL_MODEL_PTR       , WIN_BLDG_FUEL_MODEL)
ELSE
   IF (ENABLE_SPOTTING .AND. (.NOT. USE_SUPERSEDED_SPOTTING) ) THEN
      CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, BLDG_FOOTPRINT_FRAC_PTR   , WIN_BLDG_FOOTPRINT_FRAC)
   ENDIF
ENDIF
IF (USE_PYROMES) CALL MPI_WIN_ALLOCATE_SHARED(ANALYSIS_SINGLEBAND_SIZE_INT, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, PYROMES_PTR, WIN_PYROMES)

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)

IF (IRANK_HOST .NE. 0) THEN

   CALL MPI_WIN_SHARED_QUERY(WIN_WS  , 0, WX_SIZE, DISP_UNIT, WS_PTR   )
   CALL MPI_WIN_SHARED_QUERY(WIN_WD  , 0, WX_SIZE, DISP_UNIT, WD_PTR   )
   CALL MPI_WIN_SHARED_QUERY(WIN_M1  , 0, WX_SIZE, DISP_UNIT, M1_PTR   )
   CALL MPI_WIN_SHARED_QUERY(WIN_M10 , 0, WX_SIZE, DISP_UNIT, M10_PTR  )
   CALL MPI_WIN_SHARED_QUERY(WIN_M100, 0, WX_SIZE, DISP_UNIT, M100_PTR )
   CALL MPI_WIN_SHARED_QUERY(WIN_MLH , 0, WX_SIZE, DISP_UNIT, MLH_PTR  )
   CALL MPI_WIN_SHARED_QUERY(WIN_MLW , 0, WX_SIZE, DISP_UNIT, MLW_PTR  )
   CALL MPI_WIN_SHARED_QUERY(WIN_MFOL, 0, WX_SIZE, DISP_UNIT, MFOL_PTR )

   IF (USE_ERC) THEN
      CALL MPI_WIN_SHARED_QUERY(WIN_ERC    , 0, WX_SIZE, DISP_UNIT, ERC_PTR    )
      CALL MPI_WIN_SHARED_QUERY(WIN_IGNFAC , 0, WX_SIZE, DISP_UNIT, IGNFAC_PTR )
   ENDIF

   IF (USE_IGNITION_MASK)    CALL MPI_WIN_SHARED_QUERY(WIN_IGN_MASK          , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, IGN_MASK_PTR)
   CALL MPI_WIN_SHARED_QUERY(WIN_ASP          , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, ASP_PTR           )
   CALL MPI_WIN_SHARED_QUERY(WIN_CBH          , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, CBH_PTR           )
   CALL MPI_WIN_SHARED_QUERY(WIN_CBD          , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, CBD_PTR           )
   CALL MPI_WIN_SHARED_QUERY(WIN_CC           , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, CC_PTR            )
   CALL MPI_WIN_SHARED_QUERY(WIN_CH           , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, CH_PTR            )
   IF (MODE .NE. 2) CALL MPI_WIN_SHARED_QUERY(WIN_DEM          , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, DEM_PTR           )
   CALL MPI_WIN_SHARED_QUERY(WIN_FBFM         , 0, ANALYSIS_SINGLEBAND_SIZE_INT , DISP_UNIT, FBFM_PTR          )
   CALL MPI_WIN_SHARED_QUERY(WIN_SLP          , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, SLP_PTR           )
   CALL MPI_WIN_SHARED_QUERY(WIN_ADJ          , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, ADJ_PTR           )
   IF (MODE .NE. 2) CALL MPI_WIN_SHARED_QUERY(WIN_PHI0         , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, PHI0_PTR          )
   CALL MPI_WIN_SHARED_QUERY(WIN_WAF          , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, WAF_PTR           )
   CALL MPI_WIN_SHARED_QUERY(WIN_OMCOSSLPRAD  , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, OMCOSSLPRAD_PTR   )

   CALL MPI_WIN_SHARED_QUERY(WIN_ISNONBURNABLE, 0, ANALYSIS_SINGLEBAND_SIZE_L1   , DISP_UNIT, ISNONBURNABLE_PTR )

   IF (USE_POPULATION_DENSITY) CALL MPI_WIN_SHARED_QUERY(WIN_POPULATION_DENSITY,   0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, POPULATION_DENSITY_PTR )
   IF (USE_REAL_ESTATE_VALUE ) CALL MPI_WIN_SHARED_QUERY(WIN_REAL_ESTATE_VALUE ,   0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, REAL_ESTATE_VALUE_PTR  )
   IF (USE_LAND_VALUE        ) CALL MPI_WIN_SHARED_QUERY(WIN_LAND_VALUE        ,   0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, LAND_VALUE_PTR         )
   IF (USE_SDI               ) CALL MPI_WIN_SHARED_QUERY(WIN_SDI               ,   0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, SDI_PTR                )
   IF (USE_BLDG_SPREAD_MODEL) THEN
      CALL MPI_WIN_SHARED_QUERY(WIN_BLDG_AREA            , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, BLDG_AREA_PTR             )
      CALL MPI_WIN_SHARED_QUERY(WIN_BLDG_SEPARATION_DIST , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, BLDG_SEPARATION_DIST_PTR  )
      CALL MPI_WIN_SHARED_QUERY(WIN_BLDG_NONBURNABLE_FRAC, 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, BLDG_NONBURNABLE_FRAC_PTR )
      CALL MPI_WIN_SHARED_QUERY(WIN_BLDG_FOOTPRINT_FRAC  , 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, BLDG_FOOTPRINT_FRAC_PTR   )
      CALL MPI_WIN_SHARED_QUERY(WIN_BLDG_FUEL_MODEL      , 0, ANALYSIS_SINGLEBAND_SIZE_INT , DISP_UNIT, BLDG_FUEL_MODEL_PTR       )
   ELSE
      IF (ENABLE_SPOTTING .AND. (.NOT. USE_SUPERSEDED_SPOTTING) ) THEN
         CALL MPI_WIN_SHARED_QUERY(WIN_BLDG_NONBURNABLE_FRAC, 0, ANALYSIS_SINGLEBAND_SIZE_REAL, DISP_UNIT, BLDG_NONBURNABLE_FRAC_PTR )
      ENDIF
   ENDIF
   IF (USE_PYROMES) CALL MPI_WIN_SHARED_QUERY(WIN_PYROMES, 0, ANALYSIS_SINGLEBAND_SIZE_INT, DISP_UNIT, PYROMES_PTR)

ENDIF

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)

CALL C_F_POINTER(WS_PTR   , WS%R4  , ARRAYSHAPE_WX)
CALL C_F_POINTER(WD_PTR   , WD%R4  , ARRAYSHAPE_WX)
CALL C_F_POINTER(M1_PTR   , M1%R4  , ARRAYSHAPE_WX)
CALL C_F_POINTER(M10_PTR  , M10%R4 , ARRAYSHAPE_WX)
CALL C_F_POINTER(M100_PTR , M100%R4, ARRAYSHAPE_WX)
CALL C_F_POINTER(MLH_PTR  , MLH%R4 , ARRAYSHAPE_WX)
CALL C_F_POINTER(MLW_PTR  , MLW%R4 , ARRAYSHAPE_WX)
CALL C_F_POINTER(MFOL_PTR , MFOL%R4, ARRAYSHAPE_WX)

IF (USE_ERC) THEN
   CALL C_F_POINTER(ERC_PTR   , ERC%R4    , ARRAYSHAPE_WX)
   CALL C_F_POINTER(IGNFAC_PTR, IGNFAC%R4 , ARRAYSHAPE_WX)
ENDIF

IF (USE_IGNITION_MASK) CALL C_F_POINTER(IGN_MASK_PTR          , IGN_MASK%R4        , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(ASP_PTR          , ASP%R4        , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(CBH_PTR          , CBH%R4        , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(CBD_PTR          , CBD%R4        , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(CC_PTR           , CC%R4         , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(CH_PTR           , CH%R4         , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
IF (MODE .NE. 2) CALL C_F_POINTER(DEM_PTR          , DEM%R4        , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(FBFM_PTR         , FBFM%I2      , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(SLP_PTR          , SLP%R4        , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(ADJ_PTR          , ADJ%R4        , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
IF (MODE .NE. 2) CALL C_F_POINTER(PHI0_PTR         , PHI0%R4       , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(WAF_PTR          , WAF%R4        , ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(OMCOSSLPRAD_PTR  , OMCOSSLPRAD%R4, ARRAYSHAPE_ANALYSIS_SINGLEBAND )
CALL C_F_POINTER(ISNONBURNABLE_PTR, ISNONBURNABLE  , ARRAYSHAPE_ISNONBURNABLE       )
IF (USE_POPULATION_DENSITY) CALL C_F_POINTER(POPULATION_DENSITY_PTR, POPULATION_DENSITY%R4 , ARRAYSHAPE_ANALYSIS_SINGLEBAND)
IF (USE_REAL_ESTATE_VALUE ) CALL C_F_POINTER(REAL_ESTATE_VALUE_PTR , REAL_ESTATE_VALUE%R4  , ARRAYSHAPE_ANALYSIS_SINGLEBAND)
IF (USE_LAND_VALUE        ) CALL C_F_POINTER(LAND_VALUE_PTR        , LAND_VALUE%R4         , ARRAYSHAPE_ANALYSIS_SINGLEBAND)
IF (USE_SDI               ) CALL C_F_POINTER(SDI_PTR               , SDI%R4                , ARRAYSHAPE_ANALYSIS_SINGLEBAND)
IF (USE_BLDG_SPREAD_MODEL) THEN
   CALL C_F_POINTER(BLDG_AREA_PTR            , BLDG_AREA%R4            , ARRAYSHAPE_ANALYSIS_SINGLEBAND)
   CALL C_F_POINTER(BLDG_SEPARATION_DIST_PTR , BLDG_SEPARATION_DIST%R4 , ARRAYSHAPE_ANALYSIS_SINGLEBAND)
   CALL C_F_POINTER(BLDG_NONBURNABLE_FRAC_PTR, BLDG_NONBURNABLE_FRAC%R4, ARRAYSHAPE_ANALYSIS_SINGLEBAND)
   CALL C_F_POINTER(BLDG_FOOTPRINT_FRAC_PTR  , BLDG_FOOTPRINT_FRAC%R4  , ARRAYSHAPE_ANALYSIS_SINGLEBAND)
   CALL C_F_POINTER(BLDG_FUEL_MODEL_PTR      , BLDG_FUEL_MODEL%I2      , ARRAYSHAPE_ANALYSIS_SINGLEBAND)
ELSE
   IF (ENABLE_SPOTTING .AND. (.NOT. USE_SUPERSEDED_SPOTTING) ) THEN
      CALL C_F_POINTER(BLDG_FOOTPRINT_FRAC_PTR  , BLDG_FOOTPRINT_FRAC%R4  , ARRAYSHAPE_ANALYSIS_SINGLEBAND)
   ENDIF
ENDIF
IF (USE_PYROMES) CALL C_F_POINTER(PYROMES_PTR, PYROMES%I2, ARRAYSHAPE_ANALYSIS_SINGLEBAND)

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)
IF (NPROC .GT. 1) THEN
   CALL MPI_WIN_FENCE(0, WIN_WS  , IERR)
   CALL MPI_WIN_FENCE(0, WIN_WD  , IERR)
   CALL MPI_WIN_FENCE(0, WIN_M1  , IERR)
   CALL MPI_WIN_FENCE(0, WIN_M10 , IERR)
   CALL MPI_WIN_FENCE(0, WIN_M100, IERR)
   CALL MPI_WIN_FENCE(0, WIN_MLH , IERR)
   CALL MPI_WIN_FENCE(0, WIN_MLW , IERR)
   CALL MPI_WIN_FENCE(0, WIN_MFOL, IERR)

   IF (USE_ERC) THEN
      CALL MPI_WIN_FENCE(0, WIN_ERC   , IERR)
      CALL MPI_WIN_FENCE(0, WIN_IGNFAC, IERR)
   ENDIF
   IF (USE_IGNITION_MASK) CALL MPI_WIN_FENCE(0, WIN_IGN_MASK           , IERR)
   CALL MPI_WIN_FENCE(0, WIN_CBH           , IERR)
   CALL MPI_WIN_FENCE(0, WIN_CBD           , IERR)
   CALL MPI_WIN_FENCE(0, WIN_CC            , IERR)
   CALL MPI_WIN_FENCE(0, WIN_CH            , IERR)
   IF (MODE .NE. 2) CALL MPI_WIN_FENCE(0, WIN_DEM           , IERR)
   CALL MPI_WIN_FENCE(0, WIN_FBFM          , IERR)
   CALL MPI_WIN_FENCE(0, WIN_SLP           , IERR)
   CALL MPI_WIN_FENCE(0, WIN_ADJ           , IERR)
   IF (MODE .NE. 2) CALL MPI_WIN_FENCE(0, WIN_PHI0          , IERR)
   CALL MPI_WIN_FENCE(0, WIN_WAF           , IERR)
   CALL MPI_WIN_FENCE(0, WIN_OMCOSSLPRAD   , IERR)
   CALL MPI_WIN_FENCE(0, WIN_ISNONBURNABLE , IERR)

   IF (USE_POPULATION_DENSITY) CALL MPI_WIN_FENCE(0, WIN_POPULATION_DENSITY, IERR)
   IF (USE_REAL_ESTATE_VALUE ) CALL MPI_WIN_FENCE(0, WIN_REAL_ESTATE_VALUE , IERR)
   IF (USE_LAND_VALUE        ) CALL MPI_WIN_FENCE(0, WIN_LAND_VALUE        , IERR)
   IF (USE_SDI               ) CALL MPI_WIN_FENCE(0, WIN_SDI               , IERR)
   IF (USE_PYROMES           ) CALL MPI_WIN_FENCE(0, WIN_PYROMES           , IERR)

ENDIF

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)

! *****************************************************************************
END SUBROUTINE SETUP_SHARED_MEMORY_1
! *****************************************************************************

! *****************************************************************************
SUBROUTINE SETUP_SHARED_MEMORY_2
! *****************************************************************************

INTEGER :: IERR

IF (IRANK_HOST .EQ. 0) THEN
   WRITE(*,*) 'Setting up statistics arrays'
   STATS_SIZE=INT(NUM_CASES_TOTAL,MPI_ADDRESS_KIND)*4_MPI_ADDRESS_KIND   
ELSE
   STATS_SIZE=0_MPI_ADDRESS_KIND
ENDIF

CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_X_PTR                         , WIN_STATS_X                          )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_Y_PTR                         , WIN_STATS_Y                          )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_ASTOP_PTR                     , WIN_STATS_ASTOP                      )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_TSTOP_PTR                     , WIN_STATS_TSTOP                      )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_SURFACE_FIRE_AREA_PTR         , WIN_STATS_SURFACE_FIRE_AREA          )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_CROWN_FIRE_AREA_PTR           , WIN_STATS_CROWN_FIRE_AREA            )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_FIRE_VOLUME_PTR               , WIN_STATS_FIRE_VOLUME                )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_AFFECTED_POPULATION_PTR       , WIN_STATS_AFFECTED_POPULATION        )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_AFFECTED_REAL_ESTATE_VALUE_PTR, WIN_STATS_AFFECTED_REAL_ESTATE_VALUE )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_AFFECTED_LAND_VALUE_PTR       , WIN_STATS_AFFECTED_LAND_VALUE        )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_FINAL_CONTAINMENT_FRAC_PTR    , WIN_STATS_FINAL_CONTAINMENT_FRAC     )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_NEMBERS_PTR                   , WIN_STATS_NEMBERS        )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_IWX_BAND_START_PTR            , WIN_STATS_IWX_BAND_START             )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_IWX_SERIAL_BAND_PTR           , WIN_STATS_IWX_SERIAL_BAND            )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_SIMULATION_TSTOP_HOURS_PTR    , WIN_STATS_SIMULATION_TSTOP_HOURS     )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_WALL_CLOCK_TIME_PTR           , WIN_STATS_WALL_CLOCK_TIME            )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_PM2P5_RELEASE_PTR             , WIN_STATS_PM2P5_RELEASE              )
CALL MPI_WIN_ALLOCATE_SHARED (STATS_SIZE, DISP_UNIT, MPI_INFO_NULL, MPI_COMM_HOST, STATS_HRR_PEAK_PTR                  , WIN_STATS_HRR_PEAK                   )

IF (IRANK_HOST .NE. 0) THEN
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_X                         , 0, STATS_SIZE, DISP_UNIT, STATS_X_PTR                          )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_Y                         , 0, STATS_SIZE, DISP_UNIT, STATS_Y_PTR                          )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_ASTOP                     , 0, STATS_SIZE, DISP_UNIT, STATS_ASTOP_PTR                      )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_TSTOP                     , 0, STATS_SIZE, DISP_UNIT, STATS_TSTOP_PTR                      )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_SURFACE_FIRE_AREA         , 0, STATS_SIZE, DISP_UNIT, STATS_SURFACE_FIRE_AREA_PTR          )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_CROWN_FIRE_AREA           , 0, STATS_SIZE, DISP_UNIT, STATS_CROWN_FIRE_AREA_PTR            )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_FIRE_VOLUME               , 0, STATS_SIZE, DISP_UNIT, STATS_FIRE_VOLUME_PTR                )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_AFFECTED_POPULATION       , 0, STATS_SIZE, DISP_UNIT, STATS_AFFECTED_POPULATION_PTR        )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_AFFECTED_REAL_ESTATE_VALUE, 0, STATS_SIZE, DISP_UNIT, STATS_AFFECTED_REAL_ESTATE_VALUE_PTR )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_AFFECTED_LAND_VALUE       , 0, STATS_SIZE, DISP_UNIT, STATS_AFFECTED_LAND_VALUE_PTR        )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_FINAL_CONTAINMENT_FRAC    , 0, STATS_SIZE, DISP_UNIT, STATS_FINAL_CONTAINMENT_FRAC_PTR     )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_NEMBERS                   , 0, STATS_SIZE, DISP_UNIT, STATS_NEMBERS_PTR                    )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_IWX_BAND_START            , 0, STATS_SIZE, DISP_UNIT, STATS_IWX_BAND_START_PTR             )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_IWX_SERIAL_BAND           , 0, STATS_SIZE, DISP_UNIT, STATS_IWX_SERIAL_BAND_PTR            )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_SIMULATION_TSTOP_HOURS    , 0, STATS_SIZE, DISP_UNIT, STATS_SIMULATION_TSTOP_HOURS_PTR     )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_WALL_CLOCK_TIME           , 0, STATS_SIZE, DISP_UNIT, STATS_WALL_CLOCK_TIME_PTR            )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_PM2P5_RELEASE             , 0, STATS_SIZE, DISP_UNIT, STATS_PM2P5_RELEASE_PTR              )
   CALL MPI_WIN_SHARED_QUERY (WIN_STATS_HRR_PEAK                  , 0, STATS_SIZE, DISP_UNIT, STATS_HRR_PEAK_PTR                   )
ENDIF

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)

ARRAYSHAPE_STATS=(/ NUM_CASES_TOTAL /)
CALL C_F_POINTER(STATS_X_PTR                           , STATS_X                          , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_Y_PTR                           , STATS_Y                          , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_ASTOP_PTR                       , STATS_ASTOP                      , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_TSTOP_PTR                       , STATS_TSTOP                      , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_SURFACE_FIRE_AREA_PTR           , STATS_SURFACE_FIRE_AREA          , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_CROWN_FIRE_AREA_PTR             , STATS_CROWN_FIRE_AREA            , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_FIRE_VOLUME_PTR                 , STATS_FIRE_VOLUME                , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_AFFECTED_POPULATION_PTR         , STATS_AFFECTED_POPULATION        , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_AFFECTED_REAL_ESTATE_VALUE_PTR  , STATS_AFFECTED_REAL_ESTATE_VALUE , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_AFFECTED_LAND_VALUE_PTR         , STATS_AFFECTED_LAND_VALUE        , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_FINAL_CONTAINMENT_FRAC_PTR      , STATS_FINAL_CONTAINMENT_FRAC     , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_NEMBERS_PTR                     , STATS_NEMBERS                    , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_IWX_BAND_START_PTR              , STATS_IWX_BAND_START             , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_IWX_SERIAL_BAND_PTR             , STATS_IWX_SERIAL_BAND            , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_SIMULATION_TSTOP_HOURS_PTR      , STATS_SIMULATION_TSTOP_HOURS     , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_WALL_CLOCK_TIME_PTR             , STATS_WALL_CLOCK_TIME            , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_PM2P5_RELEASE_PTR               , STATS_PM2P5_RELEASE              , ARRAYSHAPE_STATS )
CALL C_F_POINTER(STATS_HRR_PEAK_PTR                    , STATS_HRR_PEAK                   , ARRAYSHAPE_STATS )

STATS_X(:) = 0.
STATS_Y(:) = 0.
STATS_ASTOP(:) = 9E9
STATS_TSTOP(:) = 0.
STATS_SURFACE_FIRE_AREA(:) = 0.
STATS_CROWN_FIRE_AREA(:) = 0.
STATS_FIRE_VOLUME(:) = 0.
STATS_AFFECTED_POPULATION(:) = 0.
STATS_AFFECTED_REAL_ESTATE_VALUE(:) = 0.
STATS_AFFECTED_LAND_VALUE(:) = 0.
STATS_FINAL_CONTAINMENT_FRAC(:) = -9999.
STATS_NEMBERS(:) = 0.
STATS_IWX_BAND_START(:) = 0
STATS_IWX_SERIAL_BAND(:) = 0
STATS_SIMULATION_TSTOP_HOURS(:) = 0.
STATS_WALL_CLOCK_TIME(:) = 0.
STATS_PM2P5_RELEASE(:) = 0.
STATS_HRR_PEAK(:) = 0.

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)

IF (NPROC .GT. 1) THEN
   CALL MPI_WIN_FENCE(0, WIN_STATS_X                          , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_Y                          , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_ASTOP                      , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_TSTOP                      , IERR)   
   CALL MPI_WIN_FENCE(0, WIN_STATS_SURFACE_FIRE_AREA          , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_CROWN_FIRE_AREA            , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_FIRE_VOLUME                , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_AFFECTED_POPULATION        , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_AFFECTED_REAL_ESTATE_VALUE , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_AFFECTED_LAND_VALUE        , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_FINAL_CONTAINMENT_FRAC     , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_NEMBERS                    , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_IWX_BAND_START             , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_IWX_SERIAL_BAND            , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_SIMULATION_TSTOP_HOURS     , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_WALL_CLOCK_TIME            , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_PM2P5_RELEASE              , IERR)
   CALL MPI_WIN_FENCE(0, WIN_STATS_HRR_PEAK                   , IERR)
ENDIF

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)

! *****************************************************************************
END SUBROUTINE SETUP_SHARED_MEMORY_2
! *****************************************************************************

! *****************************************************************************
SUBROUTINE CALC_WIND_ADJUSTMENT_FACTOR_EVERYWHERE(CC, CH, FBFM, WAF)
! *****************************************************************************
TYPE(RASTER_TYPE), INTENT(IN) :: CC, CH, FBFM
TYPE(RASTER_TYPE), INTENT(INOUT) :: WAF
REAL :: F, SHELTERED_WAF, UNSHELTERED_WAF, UNSHELTERED_FRAC

INTEGER :: IROW, ICOL, ICC, ICH

WAF%BYTEORDER     = ADJ%BYTEORDER
WAF%LAYOUT        = ADJ%LAYOUT
WAF%NROWS         = ADJ%NROWS
WAF%NCOLS         = ADJ%NCOLS
WAF%NBANDS        = ADJ%NBANDS
WAF%NBITS         = ADJ%NBITS
WAF%BANDROWBYTES  = ADJ%BANDROWBYTES
WAF%TOTALROWBYTES = ADJ%TOTALROWBYTES
WAF%PIXELTYPE     = ADJ%PIXELTYPE
WAF%ULXMAP        = ADJ%ULXMAP
WAF%ULYMAP        = ADJ%ULYMAP
WAF%XDIM          = ADJ%XDIM
WAF%YDIM          = ADJ%YDIM
WAF%NODATA_VALUE  = ADJ%NODATA_VALUE
WAF%CELLSIZE      = ADJ%CELLSIZE
WAF%XLLCORNER     = ADJ%XLLCORNER
WAF%YLLCORNER     = ADJ%YLLCORNER

DO IROW = 1, WAF%NROWS
DO ICOL = 1, WAF%NCOLS
   IF (CC%R4(ICOL,IROW,1) .LT. 0.) THEN
      WAF%R4(ICOL,IROW,1) = 0.
   ELSE
      UNSHELTERED_WAF = FUEL_MODEL_TABLE_2D(MAX(FBFM%I2(ICOL,IROW,1),0),30)%UNSHELTERED_WAF

      ICC = MIN(MAX(NINT(CC%R4(ICOL,IROW,1)*100.),0),100)
      ICH = MIN(MAX(NINT(CH%R4(ICOL,IROW,1)     ),0),120)
      SHELTERED_WAF = SHELTERED_WAF_TABLE(ICC,ICH)
      SHELTERED_WAF = MIN(SHELTERED_WAF, UNSHELTERED_WAF)

      F = 0.3333 * CC%R4(ICOL,IROW,1) * CROWN_RATIO

      IF (F .GE. 0.05) THEN
         WAF%R4(ICOL,IROW,1) = SHELTERED_WAF
      ELSE
         UNSHELTERED_FRAC = 1.0 - 20. * F
         WAF%R4(ICOL,IROW,1) = UNSHELTERED_FRAC * UNSHELTERED_WAF + (1. - UNSHELTERED_FRAC) * SHELTERED_WAF
      ENDIF
   ENDIF
ENDDO
ENDDO

! *****************************************************************************
END SUBROUTINE CALC_WIND_ADJUSTMENT_FACTOR_EVERYWHERE
! *****************************************************************************

! *****************************************************************************
SUBROUTINE ROTATE_ASP_AND_WD (ITYPE)
! *****************************************************************************

INTEGER, INTENT(IN) :: ITYPE
INTEGER :: IBAND, IROW, ICOL

SELECT CASE (ITYPE)
   CASE (1) ! Aspect
      CONTINUE 
   CASE (2) ! Wind direction
      DO IBAND = 1, WD%NBANDS
      DO IROW = 1, WD%NROWS
      DO ICOL = 1, WD%NCOLS
         WD%R4(ICOL,IROW,IBAND) = WD%R4(ICOL,IROW,IBAND) - GRID_DECLINATION
         IF (WD%R4(ICOL,IROW,IBAND) .GT. 360.) WD%R4(ICOL,IROW,IBAND) = WD%R4(ICOL,IROW,IBAND) - 360.
         IF (WD%R4(ICOL,IROW,IBAND) .LT.   0.) WD%R4(ICOL,IROW,IBAND) = WD%R4(ICOL,IROW,IBAND) + 360.
         CONTINUE
      ENDDO
      ENDDO
      ENDDO
END SELECT

! *****************************************************************************
END SUBROUTINE ROTATE_ASP_AND_WD
! *****************************************************************************

! *****************************************************************************
REAL FUNCTION CALC_WIND_ADJUSTMENT_FACTOR_SINGLE(CC, CH, FUEL_BED_HEIGHT)
! *****************************************************************************

REAL, INTENT(IN) :: CC, CH, FUEL_BED_HEIGHT

REAL :: HFT, NUMER, DENOM, UHOU20PH, F, UCOUH, HFOH, TERM1, TERM2

IF (CC .LT. 0.) THEN
   CALC_WIND_ADJUSTMENT_FACTOR_SINGLE = 0.
ELSE
   IF (CC .GT. 1E-4 .AND. CH .GT. 1E-4) THEN !Canopy is present
      HFT = CH / 0.3048 
      NUMER = 20. + 0.36*HFT
      DENOM = 0.13 * HFT
      UHOU20PH = 1. / LOG(NUMER/DENOM)
      F = 0.3333 * CC * CROWN_RATIO !Same as BEHAVE
      UCOUH = 0.555 / SQRT(F * HFT)
      CALC_WIND_ADJUSTMENT_FACTOR_SINGLE = UHOU20PH * UCOUH
   ELSE !Canopy is not present
      IF (FUEL_BED_HEIGHT .GT. 1E-4) THEN
         HFOH = 1.0 ! Same as BEHAVE and FARSITE
         HFT = FUEL_BED_HEIGHT
         NUMER = 20. + 0.36*HFT
         DENOM = 0.13 * HFT
         TERM1 = (1. + 0.36/HFOH) / LOG(NUMER/DENOM)
         NUMER = HFOH + 0.36
         TERM2 = LOG(NUMER/0.13) - 1.
         CALC_WIND_ADJUSTMENT_FACTOR_SINGLE = TERM1 * TERM2       
      ELSE
         CALC_WIND_ADJUSTMENT_FACTOR_SINGLE = 0.
      ENDIF
   ENDIF
ENDIF

CONTINUE

! *****************************************************************************
END FUNCTION CALC_WIND_ADJUSTMENT_FACTOR_SINGLE
! *****************************************************************************

! *****************************************************************************
SUBROUTINE WRITE_FUEL_MODEL_TABLE
! *****************************************************************************

CHARACTER(400) :: FNOUTPUT
INTEGER :: IOS

IF ( TRIM(FUEL_MODEL_FILE) .EQ. 'null') THEN
   FUEL_MODEL_FILE='fuel_models.csv'
   IF (TRIM(MISCELLANEOUS_INPUTS_DIRECTORY) .EQ. 'null' // PATH_SEPARATOR) MISCELLANEOUS_INPUTS_DIRECTORY=TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // PATH_SEPARATOR
   IF (TRIM(MISCELLANEOUS_INPUTS_DIRECTORY) .EQ. 'null'                  ) MISCELLANEOUS_INPUTS_DIRECTORY=TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // PATH_SEPARATOR
 
!Attempt to open fuel model table file:
   FNOUTPUT = TRIM(MISCELLANEOUS_INPUTS_DIRECTORY) // TRIM(FUEL_MODEL_FILE)
   OPEN(LUOUTPUT,FILE=TRIM(FNOUTPUT),FORM='FORMATTED',STATUS='REPLACE',IOSTAT=IOS)
   IF (IOS .GT. 0) THEN
      WRITE(*,*) 'Problem opening new fuel model table file in directory ', TRIM(MISCELLANEOUS_INPUTS_DIRECTORY)
      STOP
   ENDIF

   WRITE (LUOUTPUT,'(A)') '1,FBFM01,.FALSE.,0.034,0,0,0,0,3500,9999,9999,1,12,8000'
   WRITE (LUOUTPUT,'(A)') '2,FBFM02,.FALSE.,0.092,0.046,0.023,0.023,0,3000,1500,9999,1,15,8000'
   WRITE (LUOUTPUT,'(A)') '3,FBFM03,.FALSE.,0.138,0,0,0,0,1500,9999,9999,2.5,25,8000'
   WRITE (LUOUTPUT,'(A)') '4,FBFM04,.FALSE.,0.23,0.184,0.092,0,0.23,2000,9999,1500,6,20,8000'
   WRITE (LUOUTPUT,'(A)') '5,FBFM05,.FALSE.,0.046,0.023,0,0,0.092,2000,9999,1500,2,20,8000'
   WRITE (LUOUTPUT,'(A)') '6,FBFM06,.FALSE.,0.069,0.115,0.092,0,0,1750,9999,9999,2.5,25,8000'
   WRITE (LUOUTPUT,'(A)') '7,FBFM07,.FALSE.,0.052,0.086,0.069,0,0.017,1750,9999,1550,2.5,40,8000'
   WRITE (LUOUTPUT,'(A)') '8,FBFM08,.FALSE.,0.069,0.046,0.115,0,0,2000,9999,9999,0.2,30,8000'
   WRITE (LUOUTPUT,'(A)') '9,FBFM09,.FALSE.,0.134,0.019,0.007,0,0,2500,9999,9999,0.2,25,8000'
   WRITE (LUOUTPUT,'(A)') '10,FBFM10,.FALSE.,0.138,0.092,0.23,0,0.092,2000,9999,1500,1,25,8000'
   WRITE (LUOUTPUT,'(A)') '11,FBFM11,.FALSE.,0.069,0.207,0.253,0,0,1500,9999,9999,1,15,8000'
   WRITE (LUOUTPUT,'(A)') '12,FBFM12,.FALSE.,0.184,0.644,0.759,0,0,1500,9999,9999,2.3,20,8000'
   WRITE (LUOUTPUT,'(A)') '13,FBFM13,.FALSE.,0.322,1.058,1.288,0,0,1500,9999,9999,3,25,8000'
   WRITE (LUOUTPUT,'(A)') '14,FBFM14,.FALSE.,0.045913682,0.022956841,0,0,0,2000,2000,2000,0.2,25,8000'
   WRITE (LUOUTPUT,'(A)') '15,FBFM15,.FALSE.,0.027548209,0.009182736,0,0,0.059687787,2000,2000,1500,1.2,25,8000'
   WRITE (LUOUTPUT,'(A)') '101,GR1,.TRUE.,0.00459,0,0,0.01377,0,2200,2000,9999,0.4,15,8000'
   WRITE (LUOUTPUT,'(A)') '102,GR2,.TRUE.,0.00459,0,0,0.04591,0,2000,1800,9999,1,15,8000'
   WRITE (LUOUTPUT,'(A)') '102,GR2,.TRUE.,0.00459,0,0,0.04591,0,2000,1800,9999,1,15,8000'
   WRITE (LUOUTPUT,'(A)') '103,GR3,.TRUE.,0.00459,0.01837,0,0.06887,0,1500,1300,9999,2,30,8000'
   WRITE (LUOUTPUT,'(A)') '104,GR4,.TRUE.,0.01148,0,0,0.08724,0,2000,1800,9999,2,15,8000'
   WRITE (LUOUTPUT,'(A)') '105,GR5,.TRUE.,0.01837,0,0,0.11478,0,1800,1600,9999,1.5,40,8000'
   WRITE (LUOUTPUT,'(A)') '106,GR6,.TRUE.,0.00459,0,0,0.15611,0,2200,2000,9999,1.5,40,9000'
   WRITE (LUOUTPUT,'(A)') '107,GR7,.TRUE.,0.04591,0,0,0.24793,0,2000,1800,9999,3,15,8000'
   WRITE (LUOUTPUT,'(A)') '108,GR8,.TRUE.,0.02296,0.04591,0,0.33517,0,1500,1300,9999,4,30,8000'
   WRITE (LUOUTPUT,'(A)') '109,GR9,.TRUE.,0.04591,0.04591,0,0.41322,0,1800,1600,9999,5,40,8000'
   WRITE (LUOUTPUT,'(A)') '121,GS1,.TRUE.,0.00918,0,0,0.02296,0.02984,2000,1800,1800,0.9,15,8000'
   WRITE (LUOUTPUT,'(A)') '122,GS2,.TRUE.,0.02296,0.02296,0,0.02755,0.04591,2000,1800,1800,1.5,15,8000'
   WRITE (LUOUTPUT,'(A)') '123,GS3,.TRUE.,0.01377,0.01148,0,0.06657,0.05739,1800,1600,1600,1.8,40,8000'
   WRITE (LUOUTPUT,'(A)') '124,GS4,.TRUE.,0.08724,0.01377,0.00459,0.15611,0.32599,1800,1600,1600,2.1,40,8000'
   WRITE (LUOUTPUT,'(A)') '141,SH1,.TRUE.,0.01148,0.01148,0,0.00689,0.05969,2000,1800,1600,1,15,8000'
   WRITE (LUOUTPUT,'(A)') '142,SH2,.FALSE.,0.06198,0.11019,0.03444,0,0.17677,2000,9999,1600,1,15,8000'
   WRITE (LUOUTPUT,'(A)') '143,SH3,.FALSE.,0.02066,0.13774,0,0,0.28466,1600,9999,1400,2.4,40,8000'
   WRITE (LUOUTPUT,'(A)') '144,SH4,.FALSE.,0.03903,0.0528,0.00918,0,0.11708,2000,1800,1600,3,30,8000'
   WRITE (LUOUTPUT,'(A)') '145,SH5,.FALSE.,0.16529,0.09642,0,0,0.13315,750,9999,1600,6,15,8000'
   WRITE (LUOUTPUT,'(A)') '146,SH6,.FALSE.,0.13315,0.06657,0,0,0.06428,750,9999,1600,2,30,8000'
   WRITE (LUOUTPUT,'(A)') '147,SH7,.FALSE.,0.1607,0.24334,0.10101,0,0.15611,750,9999,1600,6,15,8000'
   WRITE (LUOUTPUT,'(A)') '148,SH8,.FALSE.,0.09412,0.15611,0.03903,0,0.19972,750,9999,1600,3,40,8000'
   WRITE (LUOUTPUT,'(A)') '149,SH9,.TRUE.,0.20661,0.11249,0,0.07117,0.3214,750,1800,1500,4.4,40,8000'
   WRITE (LUOUTPUT,'(A)') '161,TU1,.TRUE.,0.00918,0.04132,0.06887,0.00918,0.04132,2000,1800,1600,0.6,20,8000'
   WRITE (LUOUTPUT,'(A)') '162,TU2,.FALSE.,0.04362,0.08264,0.05739,0,0.00918,2000,9999,1600,1,30,8000'
   WRITE (LUOUTPUT,'(A)') '163,TU3,.TRUE.,0.05051,0.00689,0.01148,0.02984,0.05051,1800,1600,1400,1.3,30,8000'
   WRITE (LUOUTPUT,'(A)') '164,TU4,.FALSE.,0.20661,0,0,0,0.09183,2300,9999,2000,0.5,12,8000'
   WRITE (LUOUTPUT,'(A)') '165,TU5,.FALSE.,0.18365,0.18365,0.13774,0,0.13774,1500,9999,750,1,25,8000'
   WRITE (LUOUTPUT,'(A)') '181,TL1,.FALSE.,0.04591,0.10101,0.16529,0,0,2000,9999,9999,0.2,30,8000'
   WRITE (LUOUTPUT,'(A)') '182,TL2,.FALSE.,0.06428,0.1056,0.10101,0,0,2000,9999,9999,0.2,25,8000'
   WRITE (LUOUTPUT,'(A)') '183,TL3,.FALSE.,0.02296,0.10101,0.12856,0,0,2000,9999,9999,0.3,20,8000'
   WRITE (LUOUTPUT,'(A)') '184,TL4,.FALSE.,0.02296,0.06887,0.19284,0,0,2000,9999,9999,0.4,25,8000'
   WRITE (LUOUTPUT,'(A)') '185,TL5,.FALSE.,0.0528,0.11478,0.20202,0,0,2000,9999,1600,0.6,25,8000'
   WRITE (LUOUTPUT,'(A)') '186,TL6,.FALSE.,0.11019,0.0551,0.0551,0,0,2000,9999,9999,0.3,25,8000'
   WRITE (LUOUTPUT,'(A)') '187,TL7,.FALSE.,0.01377,0.06428,0.3719,0,0,2000,9999,9999,0.4,25,8000'
   WRITE (LUOUTPUT,'(A)') '188,TL8,.FALSE.,0.2663,0.06428,0.05051,0,0,1800,9999,9999,0.3,35,8000'
   WRITE (LUOUTPUT,'(A)') '189,TL9,.FALSE.,0.30533,0.15152,0.19054,0,0,1800,9999,1600,0.6,35,8000'
   WRITE (LUOUTPUT,'(A)') '201,SB1,.FALSE.,0.06887,0.13774,0.50505,0,0,2000,9999,9999,1,25,8000'
   WRITE (LUOUTPUT,'(A)') '202,SB2,.FALSE.,0.20661,0.19513,0.18365,0,0,2000,9999,9999,1,25,8000'
   WRITE (LUOUTPUT,'(A)') '203,SB3,.FALSE.,0.25253,0.12626,0.13774,0,0,2000,9999,9999,1.2,25,8000'
   WRITE (LUOUTPUT,'(A)') '204,SB4,.FALSE.,0.24105,0.1607,0.24105,0,0,2000,9999,9999,2.7,25,8000'
   WRITE (LUOUTPUT,'(A)') '256,NB,.FALSE.,0.0001,0,0,0,0,9999,9999,9999,0.01,5,1'
   CLOSE(LUOUTPUT)
ENDIF

! *****************************************************************************
END SUBROUTINE WRITE_FUEL_MODEL_TABLE
! *****************************************************************************

! *****************************************************************************
SUBROUTINE READ_FUEL_MODEL_TABLE
! *****************************************************************************

CHARACTER(400) :: FNINPUT
INTEGER :: I, INUM, IOS, ILH
REAL :: LIVEFRAC, DEADFRAC, LH
INTEGER, PARAMETER :: NUM_FUEL_MODELS = 303
TYPE(FUEL_MODEL_TABLE_TYPE) :: FM

TYPE(FUEL_MODEL_TABLE_TYPE), ALLOCATABLE, DIMENSION(:) :: FUEL_MODEL_TABLE

ALLOCATE(FUEL_MODEL_TABLE(0:NUM_FUEL_MODELS))

FUEL_MODEL_TABLE(:)%SHORTNAME='NULL' !Initialize fuel model names

FM%SIG(2) = 109.  !  10-hour surface area to volume ratio, 1/ft
FM%SIG(3) =  30.  ! 100-hour surface area to volume ratio, 1/ft
FM%RHOP   =  32.  ! Particle density
FM%ST     =   0.055
FM%SE     =   0.01
FM%ETAS   = 0.174/(FM%SE**0.19) !Mineral damping coefficient, dimensionless

FNINPUT = TRIM(MISCELLANEOUS_INPUTS_DIRECTORY) // TRIM(FUEL_MODEL_FILE)

!Attempt to open fuel model table file:
OPEN(LUINPUT,FILE=TRIM(FNINPUT),FORM='FORMATTED',STATUS='OLD',IOSTAT=IOS)
IF (IOS .GT. 0) THEN
   WRITE(*,*) 'Problem opening fuel model table file ', TRIM(FNINPUT)
   STOP
ENDIF

!Read fuel models and store in FUEL_MODEL_TABLE
IOS = 0
DO WHILE (IOS .EQ. 0)
   READ(LUINPUT,*,IOSTAT=IOS) INUM,FM%SHORTNAME,FM%DYNAMIC,FM%W0(1),FM%W0(2),FM%W0(3),FM%W0(5), &
                                   FM%W0(6),FM%SIG(1),FM%SIG(5),FM%SIG(6),FM%DELTA,FM%MEX_DEAD,FM%HOC
   IF (IOS .EQ. 0) THEN
      FM%MEX_DEAD = FM%MEX_DEAD / 100.
      FUEL_MODEL_TABLE(INUM) = FM
   ENDIF
ENDDO
CLOSE(LUINPUT)

DO INUM = 0, NUM_FUEL_MODELS
   IF ( TRIM(FUEL_MODEL_TABLE(INUM)%SHORTNAME) .EQ. 'NULL' ) CYCLE
   FUEL_MODEL_TABLE_2D(INUM,:) = FUEL_MODEL_TABLE(INUM)

   DO ILH = 30, 120
      LH = REAL(ILH)
      FM = FUEL_MODEL_TABLE_2D(INUM,ILH)

      IF (FM%DYNAMIC) THEN
         LIVEFRAC  = MIN( MAX( (LH - 30. ) / (120.  - 30. ) , 0.), 1.)
         DEADFRAC  = 1. - LIVEFRAC
         FM%W0 (4) = DEADFRAC * FM%W0(5)
         FM%W0 (5) = LIVEFRAC * FM%W0(5)
         FM%SIG(4) = FM%SIG(5)
         FM%SIG(1) = (FM%SIG(1)*FM%SIG(1)*FM%W0(1) + FM%SIG(4)*FM%SIG(4)*FM%W0(4)) / ( FM%SIG(1)*FM%W0(1) + FM%SIG(4)*FM%W0(4) )
         FM%W0 (1) = FM%W0(1) + FM%W0(4)
         FM%W0 (4) = 0.
         FM%SIG(4) = 9999.
      ELSE
         FM%W0 (4) = 0.0
         FM%SIG(4) = 9999.
      ENDIF
   
      FM%A(:) = FM%SIG(:)*FM%W0(:) / FM%RHOP

      FM%A_DEAD = MAX(SUM(FM%A(1:4)),1E-9)
      FM%A_LIVE = MAX(SUM(FM%A(5:6)),1E-9)
      FM%A_OVERALL = FM%A_DEAD + FM%A_LIVE

      FM%F   (1:4) = FM%A(1:4) / FM%A_DEAD
      FM%FMEX(1:4) = FM%F(1:4) * FM%MEX_DEAD
      FM%F   (5:6) = FM%A(5:6) / FM%A_LIVE 
   
      FM%F_DEAD = FM%A_DEAD / FM%A_OVERALL
      FM%F_LIVE = FM%A_LIVE / FM%A_OVERALL

      FM%FW0(:) = FM%F(:) * FM%W0(:)
   
      FM%FSIG(:) = FM%F(:) * FM%SIG(:)

      FM%EPS(:) = EXP(-138. / FM%SIG(:))

      FM%FEPS(:) = FM%F(:) * FM%EPS(:)

      FM%WPRIMENUMER(1:4) = FM%W0(1:4) * FM%EPS(1:4)
      FM%WPRIMEDENOM(5:6) = FM%W0(5:6) * EXP(-500./FM%SIG(5:6))

      FM%MPRIMEDENOM(1:4) = FM%W0(1:4) * FM%EPS(1:4)
   
      FM%W0_DEAD = SUM(FM%FW0(1:4))
      FM%W0_LIVE = SUM(FM%FW0(5:6))
   
      FM%WN_DEAD = FM%W0_DEAD * (1. - FM%ST)
      FM%WN_LIVE = FM%W0_LIVE * (1. - FM%ST)
      
      FM%SIG_DEAD = SUM(FM%FSIG(1:4))
      FM%SIG_LIVE = SUM(FM%FSIG(5:6))
  
      FM%SIG_OVERALL = FM%F_DEAD * FM%SIG_DEAD + FM%F_LIVE * FM%SIG_LIVE
      FM%BETA        = SUM(FM%W0(1:6)) / (FM%DELTA * FM%RHOP)
      FM%BETAOP      = 3.348/(FM%SIG_OVERALL**0.8189)
      FM%RHOB        = SUM(FM%W0(1:6)) / FM%DELTA
   
      FM%XI = EXP((0.792 + 0.681*SQRT(FM%SIG_OVERALL))*(0.1+FM%BETA)) / (192. + 0.2595*FM%SIG_OVERALL)
   
      FM%A_COEFF = 133./(FM%SIG_OVERALL**0.7913)
      FM%B_COEFF = 0.02526*FM%SIG_OVERALL**0.54
      FM%C_COEFF = 7.47*EXP(-0.133*FM%SIG_OVERALL**0.55)
      FM%E_COEFF = 0.715*(EXP(-0.000359*FM%SIG_OVERALL))
   
      FM%GAMMAPRIMEPEAK = FM%SIG_OVERALL**1.5 / (495. + 0.0594*FM%SIG_OVERALL**1.5)
      FM%GAMMAPRIME = FM%GAMMAPRIMEPEAK*(FM%BETA/FM%BETAOP)**FM%A_COEFF*EXP(FM%A_COEFF*(1.-FM%BETA/FM%BETAOP))
   
      FM%TR = 384. / FM%SIG_OVERALL

      FM%GP_WND_EMD_ES_HOC = FM%GAMMAPRIME * FM%WN_DEAD * FM%ETAS * FM%HOC
      FM%GP_WNL_EML_ES_HOC = FM%GAMMAPRIME * FM%WN_LIVE * FM%ETAS * FM%HOC

      FM%PHISTERM=5.275 * FM%BETA**(-0.3)
      FM%PHIWTERM = FM%C_COEFF * (FM%BETA / FM%BETAOP)**(-FM%E_COEFF)

      FM%B_COEFF_INVERSE = 1. / FM%B_COEFF
      FM%WSMFEFF_COEFF = (1. / FM%PHIWTERM) ** FM%B_COEFF_INVERSE

      FM%WPRIMEDENOM56SUM = SUM(FM%WPRIMEDENOM(5:6))
      FM%WPRIMENUMER14SUM = SUM(FM%WPRIMENUMER(1:4))
      FM%MPRIMEDENOM14SUM = SUM(FM%MPRIMEDENOM(1:4))

      FM%R_MPRIMEDENOME14SUM_MEX_DEAD = 1. / (FM%MPRIMEDENOM14SUM * FM%MEX_DEAD)

      FM%UNSHELTERED_WAF = CALC_WIND_ADJUSTMENT_FACTOR_SINGLE(0., 0., FM%DELTA)

      IF (FM%WPRIMEDENOM56SUM .GT. 1E-6) THEN
         FM%MEX_LIVE = 2.9 * FM%WPRIMENUMER14SUM / FM%WPRIMEDENOM56SUM
      ELSE
         FM%MEX_LIVE = 100.0
      ENDIF

      FUEL_MODEL_TABLE_2D(INUM,ILH) = FM

   ENDDO

ENDDO

!Set any unused fuel models to 256 (NB)
DO INUM = 0, NUM_FUEL_MODELS
DO ILH = 30, 120
   IF ( TRIM(FUEL_MODEL_TABLE_2D(INUM,ILH)%SHORTNAME) .EQ. 'NULL' ) FUEL_MODEL_TABLE_2D(INUM,ILH) = FUEL_MODEL_TABLE(256)
ENDDO
ENDDO

DO I = 1, NUM_FUEL_MODELS
   WSMFEFF_COEFF  (I) = FUEL_MODEL_TABLE_2D(I,30)%WSMFEFF_COEFF
   B_COEFF_INVERSE(I) = FUEL_MODEL_TABLE_2D(I,30)%B_COEFF_INVERSE
   TR             (I) = FUEL_MODEL_TABLE_2D(I,30)%TR
ENDDO   

! *****************************************************************************
END SUBROUTINE READ_FUEL_MODEL_TABLE
! *****************************************************************************

! *****************************************************************************
SUBROUTINE READ_BUILDING_FUEL_MODEL_TABLE
! *****************************************************************************

CHARACTER(400) :: FNINPUT
CHARACTER(80) :: SHORTNAME
REAL :: T_1MW, T_EARLY, T_FULLDEV, T_DECAY, FUEL_LOAD, HRRPUA_PEAK, FTP_CRIT, Q_CRIT, ABSORPTIVITY, &
        HEIGHT, NONBURNABLE_FRAC, P_IGNITION, HARDENING_FACTOR, TAU_IGN
INTEGER :: INUM, IOS

! Initialize building fuel model table:
BUILDING_FUEL_MODEL_TABLE(:)%SHORTNAME='NULL'
BUILDING_FUEL_MODEL_TABLE(:)%T_1MW=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%T_EARLY=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%T_FULLDEV=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%T_DECAY=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%FUEL_LOAD=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%HRRPUA_PEAK=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%FTP_CRIT=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%Q_CRIT=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%ABSORPTIVITY=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%HEIGHT=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%NONBURNABLE_FRAC=-9999.
BUILDING_FUEL_MODEL_TABLE(:)%P_IGNITION=PIGN
BUILDING_FUEL_MODEL_TABLE(:)%HARDENING_FACTOR=GLOBAL_HARDENING_FACTOR
BUILDING_FUEL_MODEL_TABLE(:)%TAU_IGN=-9999.

!Attempt to open fuel model table file:
FNINPUT = TRIM(MISCELLANEOUS_INPUTS_DIRECTORY) // TRIM(BUILDING_FUEL_MODEL_FILE)
OPEN(LUINPUT,FILE=TRIM(FNINPUT),FORM='FORMATTED',STATUS='OLD',IOSTAT=IOS)
IF (IOS .GT. 0) THEN
   WRITE(*,*) 'Problem opening building fuel model table file ', TRIM(FNINPUT)
   STOP
ENDIF

!Read fuel models and store in BUILDING_FUEL_MODEL_TABLE
IOS = 0
DO WHILE (IOS .EQ. 0)
   READ(LUINPUT,*,IOSTAT=IOS) INUM,SHORTNAME,T_1MW,T_EARLY,T_FULLDEV,T_DECAY,FUEL_LOAD,HRRPUA_PEAK,FTP_CRIT,&
   Q_CRIT,ABSORPTIVITY,HEIGHT,NONBURNABLE_FRAC,P_IGNITION, HARDENING_FACTOR, TAU_IGN
   IF (IOS .EQ. 0 .AND. INUM .GE. 0 .AND. INUM .LE. NUM_BUILDING_FUEL_MODELS) THEN
      BUILDING_FUEL_MODEL_TABLE(INUM)%SHORTNAME        = SHORTNAME
      BUILDING_FUEL_MODEL_TABLE(INUM)%T_1MW            = T_1MW
      BUILDING_FUEL_MODEL_TABLE(INUM)%T_EARLY          = T_EARLY
      BUILDING_FUEL_MODEL_TABLE(INUM)%T_FULLDEV        = T_FULLDEV
      BUILDING_FUEL_MODEL_TABLE(INUM)%T_DECAY          = T_DECAY
      BUILDING_FUEL_MODEL_TABLE(INUM)%FUEL_LOAD        = FUEL_LOAD
      BUILDING_FUEL_MODEL_TABLE(INUM)%HRRPUA_PEAK      = HRRPUA_PEAK
      BUILDING_FUEL_MODEL_TABLE(INUM)%FTP_CRIT         = FTP_CRIT
      BUILDING_FUEL_MODEL_TABLE(INUM)%Q_CRIT           = Q_CRIT
      BUILDING_FUEL_MODEL_TABLE(INUM)%ABSORPTIVITY     = ABSORPTIVITY
      BUILDING_FUEL_MODEL_TABLE(INUM)%HEIGHT           = HEIGHT
      BUILDING_FUEL_MODEL_TABLE(INUM)%NONBURNABLE_FRAC = NONBURNABLE_FRAC
      BUILDING_FUEL_MODEL_TABLE(INUM)%P_IGNITION       = P_IGNITION
      BUILDING_FUEL_MODEL_TABLE(INUM)%HARDENING_FACTOR = HARDENING_FACTOR
      BUILDING_FUEL_MODEL_TABLE(INUM)%TAU_IGN          = TAU_IGN
   ENDIF
ENDDO
CLOSE(LUINPUT)

! *****************************************************************************
END SUBROUTINE READ_BUILDING_FUEL_MODEL_TABLE
! *****************************************************************************

END MODULE
